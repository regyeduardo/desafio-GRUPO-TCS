{% extends 'base.html' %}
{% block title %} Dashboard {% endblock %}

{% block style %}
<!-- <style>
.form-control {
  padding-right: 30px;
}

.form-control + .fas {
  position: absolute;
  right: 0;
  padding: 8px 27px;
} -->
</style>
{% endblock %}

{% block body %}
<h1>Usuario logado</h1>

<a href="{% url 'login:logout' %}">LOGOUT</a>

<div class="container">
    <div class="row">
        <div class="col-sm">
            <h2>Status</h2>
            <button type="button" class="btn btn-primary" id="create_status">Criar Status</button>
            <div class="card">
                <div class="card-body">
                    {% if messages %}
                        {% for message in messages %}
                            {% if message.level %}
                                <div class="alert alert-{{ message.tags }} " role="alert">
                                    {{ message }}
                                    <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                                        <span aria-hidden="true">&times;</span>
                                    </button>
                                </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}

                    {% if all_status %}
                        {% for status in all_status %}
                            <form action="" method="post" class="form-inline mb-3">
                                <div class="row w-100">
                                    <div class="form-group">
                                        <div class="col">
                                            <div class="input-group">
                                                <input type="text" class="form-control" name="codigo" curValue="{{ status.codigo }}" value="{{ status.codigo }}"
                                                    disabled>
                                                <span class="input-group-append">
                                                    <i class="input-group-text bi bi-pencil-square"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                            
                                    <div class="form-group">
                                        <div class="col">
                                            <div class="input-group">
                                                <input type="text" class="form-control" name="nome" curValue="{{ status.nome }}"
                                                    value="{{ status.nome }}" disabled>
                                                <span class="input-group-append">
                                                    <i class="input-group-text bi bi-pencil-square"></i>
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                            
                                    <div class="form-group">
                                        <div class="col">
                                                <button type="submit" class="btn btn-danger botao-apagar w-100">Apagar</button>
                                        </div>
                                    </div>
                                </div>
                            </form>
                        {% endfor %}
                    {% else %}
                        <p class="lead vazio text-center">
                            Não há nenhum status.
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

</div>
<script>
    const removeEditIcon = spanInputGroupAppend => {
        spanInputGroupAppend.remove()
    }

    const addEditIcon = (formControl) => {
        const inputGroup = formControl.parentElement
        const hasSPAN = inputGroup.querySelector('.input-group-append')

        if (!hasSPAN) {
            const span = document.createElement("SPAN")
            const templeteSendIcon = `
            <i class="input-group-text bi bi-pencil-square"></i>
            `
            span.setAttribute("class", "input-group-append")
            span.innerHTML = templeteSendIcon

            inputGroup.appendChild(span)

            return true
        }

        return false
    }

    const addSendIcon = (formControl) => {
        const inputGroup = formControl.parentElement
        const hasSPAN = inputGroup.querySelector('.input-group-append')

        if (!hasSPAN) {
            const span = document.createElement("SPAN")
            const templeteSendIcon = `
            <i class="input-group-text bi bi-send" data-toggle="collapse" data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample"></i>
            `
            span.setAttribute("class", "input-group-append")
            span.innerHTML = templeteSendIcon

            inputGroup.appendChild(span)

            return true
        }

        return false
    }

    const removeSendIcon = formControl => {
        const inputGroup = formControl.parentElement
        const span = inputGroup.querySelector('.input-group-append')
        if (span) {
            span.remove()
            return true
        }

        return false
    }

    const checkIfInputValueWasEdited = formControl => {
        if (formControl.value != formControl.getAttribute('curValue')) return true
        return false
    }

    const removeIcons = formControl => {
        const row = formControl.parentElement.parentElement.parentElement.parentElement
        const rowChildren = Array.prototype.slice.call(row.children)

        rowChildren.forEach(formGroup => {
            const siblingFormControl = formGroup.querySelector('.form-control')

            if (siblingFormControl) {
                if (checkIfInputValueWasEdited(siblingFormControl)) {
                    const span = formGroup.querySelector('.input-group-append')
                    if (span) {
                        span.remove()
                    }
                }
            }
        })
    }

    const removeEditIcons = (form) => {
        const cardBody = form.parentElement
        const biPencilSquares =  Array.prototype.slice.call(cardBody.querySelectorAll('.bi-pencil-square'))

        biPencilSquares.forEach(biPencilSquare => {
            const inputGroupAppend = biPencilSquare.parentElement

            inputGroupAppend.remove()
        })

    }

    const setAttributeDisabledAndRemoveAutofocus = formControl => {
        if (formControl.hasAttribute('autofocus')) {
            formControl.removeAttribute('autofocus')
        }
        formControl.setAttribute('disabled', '')
    }

    const checkIfAtLeast2FieldsHaveBeenEdited = formControl => {
        const row = formControl.parentElement.parentElement.parentElement.parentElement
        const formControls = Array.prototype.slice.call(row.querySelectorAll('.form-control'))
        const editedFields = formControls.reduce((acc, nestedFormControl) => {
            if (checkIfInputValueWasEdited(nestedFormControl)) return acc += 1
            return acc
        }, 0)

        if (editedFields >= 2) return true
        return false
    }

    const addSubmitButton = formControl => {
        const row = formControl.parentElement.parentElement.parentElement.parentElement
        const submitButton = row.querySelector('.botao-enviar')

        if (!submitButton) {
            const div = document.createElement("div")
            div.setAttribute("class", "form-group")
            div.innerHTML = `
            <div class="col">
                <div class="input-group">
                    <button type="submit" class="btn btn-success botao-enviar">Enviar</button>
                </div>
            </div>
            `
            const rowChildren = Array.prototype.slice.call(row.children)
            row.insertBefore(div, rowChildren.slice('-1')[0])
        }
    }

    const removeSubmitButton = formControl => {
        const row = formControl.parentElement.parentElement.parentElement.parentElement
        const submitButton = row.querySelector('.botao-enviar')

        if (submitButton) {
            const formGroup = submitButton.parentElement.parentElement.parentElement
            formGroup.remove()

            return true
        }

        return false
    }

    const getAllSiblings = (elem) => {
        const siblings = [];

        if (!elem.parentNode) {
            return siblings;
        }

        let sibling = elem.parentNode.firstElementChild;

        do {
            if (sibling != elem) {
                siblings.push(sibling);
            }
        } while (sibling = sibling.nextElementSibling);

        return siblings;
    };

    const addEditIconInEditedFields = formControl => {
        const formGroup = formControl.parentElement.parentElement.parentElement

        const colSiblings = getAllSiblings(formGroup)

        colSiblings.forEach(sibling => {
            const siblingInput = sibling.querySelector('.form-control')

            if (siblingInput) {
                const siblingInputWasEdited = checkIfInputValueWasEdited(siblingInput)

                if (siblingInputWasEdited) addSendIcon(siblingInput)
            }

        })
    }

    const changeMethodForm = (form, method) => {
        form.setAttribute('method', method)
    }

    const createEventEditButton = formControl => {
        const inputGroupAppend = formControl.nextElementSibling
        const form = formControl.parentElement.parentElement.parentElement.parentElement.parentElement
        const method = 'put'
        inputGroupAppend.addEventListener('click', (e) => {
            changeMethodForm(form, method)

            const templateCollapse = `
            <div class="card card-body">
                <p>Tem certeza que deseja atualizar?</p>
                <div class="btn-toolbar mb-3 d-flex justify-content-center">
                    <div class="btn-group mr-2">
                        <button type="submit" class='btn btn-secondary'>SIM</button>
                    </div>
                    <div class="btn-group mr-2">
                        <button type="submit" class='btn btn-primary'>NAO</button>
                    </div>
                </div>
            </div>
        `
            const divCollapse = document.createElement('div')
            divCollapse.setAttribute('class', 'collapse show position-fixed')
            divCollapse.setAttribute('id', 'collapseExemple')
            divCollapse.setAttribute('style', 'z-index: 9999;')
            divCollapse.innerHTML = templateCollapse
            const col = inputGroupAppend.parentElement.parentElement

            if (!col.querySelector('.collapse')) col.appendChild(divCollapse)

            removeEditIcons(form)

            formControl.removeEventListener('click', () => {})
        })
    }

    const createEventClickEditIcon = editIcon => {
        editIcon.addEventListener('click', (event) => {

            const spanInputGroupAppend = editIcon.parentElement
            const disabledInput = spanInputGroupAppend.previousElementSibling
            removeEditIcon(spanInputGroupAppend)

            editIcon.removeEventListener('click', () => { })
            disabledInput.removeAttribute('disabled')
            disabledInput.setAttribute('autofocus', '')
        })
    }

    const createEventFocusOutInput = formControl => {
        formControl.addEventListener('focusout', (event) => {
            const inputWasEdited = checkIfInputValueWasEdited(formControl)

            formControl.removeEventListener('focusout', () => { })

            if (inputWasEdited) {
                const atLeast2FieldsWereEdited = checkIfAtLeast2FieldsHaveBeenEdited(formControl)
                
                if (atLeast2FieldsWereEdited) {
                    addSubmitButton(formControl)
                    removeIcons(formControl)
                } else {
                    addSendIcon(formControl)
                    createEventEditButton(formControl)
                }
            } else {
                removeSendIcon(formControl)
                if (removeSubmitButton(formControl)) {
                    addEditIconInEditedFields(formControl)
                }
                addEditIcon(formControl)
                setAttributeDisabledAndRemoveAutofocus(formControl)

                const editIcon = formControl.nextElementSibling.firstElementChild
                createEventClickEditIcon(editIcon)
            }

        })
    }

    const disabledInputs = Array.prototype.slice.call(document.querySelectorAll('input[disabled]'))

    disabledInputs.forEach(disabledInput => {
        const editIcon = disabledInput.nextElementSibling.firstElementChild
        createEventClickEditIcon(editIcon)
        createEventFocusOutInput(disabledInput)
    });

    const botaoStatus = document.querySelector('#create_status')

    botaoStatus.addEventListener('click', (e) => {
        const template = `
            <div class="row w-100">
                <div class="col">
                    <div class="input-group">
                        <input type="text" class="form-control" name="codigo" required>
                    </div>
                        </div>
        
                <div class="col">
                    <div class="input-group">
                        <input type="text" class="form-control" name="nome" required>
                    </div>
                </div>
        
                <div class="col">
                        <button type="submit" class="btn btn-success w-100">Enviar</button>
                </div>
            </div>
        `
        const form = document.createElement('form')
        form.setAttribute("action", '') 
        form.setAttribute("method", 'post') 
        form.setAttribute("class", 'form-inline mb-3') 
        form.innerHTML = template
        const cardBody = botaoStatus.nextElementSibling.firstElementChild
        if (cardBody.querySelector('.alert')) {

        } else if (cardBody.querySelector('.vazio')) {
            const vazio = cardBody.querySelector('.vazio')
            cardBody.insertBefore(form, vazio)
            vazio.remove()
        } else {
            const firstForm = cardBody.querySelector('form')
            cardBody.insertBefore(form, firstForm)
        }

        botaoStatus.removeEventListener('click', ()=>{})
        botaoStatus.remove()
    })

    if (window.history.replaceState) {
            window.history.replaceState(null, null, window.location.href);
    }
</script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css">
{% endblock %}